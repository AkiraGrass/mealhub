name: Deploy to Lightsail  # Workflow 名稱，顯示於 GitHub Actions UI

on:
  workflow_dispatch:      # 手動觸發，可指定分支
    inputs:
      branch:
        description: "要部署的分支名稱（例如 master）"
        required: true
        default: "master"

env:
  LIGHTSAIL_CONTAINER_NAME: ${{ secrets.LIGHTSAIL_CONTAINER_NAME || 'mealhub-app' }}  # VM 上的容器名稱
  LIGHTSAIL_ENV_FILE: ${{ secrets.LIGHTSAIL_ENV_FILE }}  # VM 上 .env 檔路徑（可選）
  LIGHTSAIL_HEALTH_PATH: ${{ secrets.LIGHTSAIL_HEALTH_PATH }} # 健康檢查路徑（可選，預設 /）
  LIGHTSAIL_SERVER_NAME: ${{ secrets.LIGHTSAIL_SERVER_NAME }} # Nginx server_name（可選，預設 _）
  IMAGE_NAME: mealhub                                    # 本地/VM 上的 image 名稱
  IMAGE_LABEL: ${{ github.sha }}                         # 使用 commit SHA 當 image tag

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup PHP for tests
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, intl, pdo_pgsql, pdo_mysql

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache
            src/mealhub/vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('src/mealhub/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dependencies & run PHPUnit
        working-directory: src/mealhub
        run: |
          composer install --no-interaction --prefer-dist
          cp .env.example .env
          php artisan key:generate --force
          php artisan test

      - name: Build Docker image        # 建置可部署的容器映像（使用 cache）
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_LABEL }}
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Export Docker image
        run: |
          docker save $IMAGE_NAME:$IMAGE_LABEL | gzip > image.tar.gz

      - name: Upload image to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_SSH_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          source: "image.tar.gz"
          target: "/tmp"

      - name: Deploy on VM
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          IMAGE_LABEL: ${{ env.IMAGE_LABEL }}
          LIGHTSAIL_CONTAINER_NAME: ${{ env.LIGHTSAIL_CONTAINER_NAME }}
          LIGHTSAIL_ENV_FILE: ${{ env.LIGHTSAIL_ENV_FILE }}
          LIGHTSAIL_HEALTH_PATH: ${{ env.LIGHTSAIL_HEALTH_PATH }}
          LIGHTSAIL_SERVER_NAME: ${{ env.LIGHTSAIL_SERVER_NAME }}
          LIGHTSAIL_HOST: ${{ secrets.LIGHTSAIL_HOST }}
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_SSH_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          envs: IMAGE_NAME,IMAGE_LABEL,LIGHTSAIL_CONTAINER_NAME,LIGHTSAIL_ENV_FILE,LIGHTSAIL_HEALTH_PATH,LIGHTSAIL_SERVER_NAME,LIGHTSAIL_HOST
          script: |
            set -euo pipefail
            docker load -i /tmp/image.tar.gz
            ENV_FILE_ARG=""
            if [ -n "${LIGHTSAIL_ENV_FILE:-}" ]; then
              ENV_FILE_ARG="--env-file $LIGHTSAIL_ENV_FILE"
            fi

            HEALTH_PATH="${LIGHTSAIL_HEALTH_PATH:-/}"
            SERVER_NAME="${LIGHTSAIL_SERVER_NAME:-${LIGHTSAIL_HOST:-_}}"
            NGINX_CID="$(docker ps --filter 'label=com.docker.compose.service=nginx' -q | head -n1)"
            if [ -z "$NGINX_CID" ]; then
              NGINX_CID="$(docker ps --filter 'name=nginx' -q | head -n1)"
            fi
            if [ -z "$NGINX_CID" ]; then
              echo "nginx container not found"
              exit 1
            fi

            CONF_DIR="$(docker inspect -f '{{range .Mounts}}{{if eq .Destination "/etc/nginx/conf.d"}}{{.Source}}{{end}}{{end}}' "$NGINX_CID")"
            if [ -z "$CONF_DIR" ]; then
              CONF_DIR="/etc/nginx/conf.d"
            fi
            NGINX_CONF="${CONF_DIR%/}/mealhub.conf"

            NET_CID="$(docker ps --filter 'label=com.docker.compose.service=db' -q | head -n1)"
            if [ -z "$NET_CID" ]; then
              NET_CID="$(docker ps --filter 'label=com.docker.compose.service=app' -q | head -n1)"
            fi
            if [ -z "$NET_CID" ]; then
              echo "compose network not found (no db/app container)"
              exit 1
            fi
            NET_NAME="$(docker inspect -f '{{range $k,$v := .NetworkSettings.Networks}}{{println $k}}{{end}}' "$NET_CID" | head -n1)"
            if [ -z "$NET_NAME" ]; then
              echo "failed to detect network name"
              exit 1
            fi

            CURRENT_UPSTREAM=""
            if sudo test -f "$NGINX_CONF"; then
              CURRENT_UPSTREAM="$(sudo grep -oP 'proxy_pass http://\K[^;]+' "$NGINX_CONF" 2>/dev/null | head -n1 || true)"
            fi
            NAME_A="${LIGHTSAIL_CONTAINER_NAME}-a"
            NAME_B="${LIGHTSAIL_CONTAINER_NAME}-b"
            if [ "$CURRENT_UPSTREAM" = "${NAME_B}:8080" ]; then
              NEW_NAME="$NAME_A"
            elif [ "$CURRENT_UPSTREAM" = "${NAME_A}:8080" ]; then
              NEW_NAME="$NAME_B"
            else
              if ! docker ps -a --format '{{.Names}}' | grep -x "$NAME_A" >/dev/null 2>&1; then
                NEW_NAME="$NAME_A"
              elif ! docker ps -a --format '{{.Names}}' | grep -x "$NAME_B" >/dev/null 2>&1; then
                NEW_NAME="$NAME_B"
              else
                NEW_NAME="$NAME_A"
              fi
            fi
            echo "Current upstream: ${CURRENT_UPSTREAM:-<none>}"
            echo "New container: $NEW_NAME"

            docker stop --timeout 30 "$NEW_NAME" 2>/dev/null || true
            docker rm "$NEW_NAME" 2>/dev/null || true

            docker run -d \
              --name "$NEW_NAME" \
              --network "$NET_NAME" \
              --restart unless-stopped \
              $ENV_FILE_ARG \
              "$IMAGE_NAME:$IMAGE_LABEL"

            ok=""
            HEALTH_PORT=8080
            echo "Health check port: ${HEALTH_PORT}"
            echo "Waiting for container to start..."
            sleep 5
            for i in $(seq 1 30); do
              if docker exec "$NEW_NAME" curl -fsS "http://127.0.0.1:${HEALTH_PORT}${HEALTH_PATH}" >/dev/null; then
                ok="yes"
                break
              fi
              sleep 2
            done
            if [ -z "$ok" ]; then
              docker logs --tail 200 "$NEW_NAME" || true
              docker exec "$NEW_NAME" sh -lc 'ls -l /etc/nginx/conf.d && grep -n "listen" /etc/nginx/conf.d/default.conf || true' || true
              echo "Health check failed; keeping container $NEW_NAME for debugging."
              exit 1
            fi

            sudo tee "$NGINX_CONF" >/dev/null <<EOF
            server {
                listen 80;
                server_name ${SERVER_NAME};

                location / {
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                    proxy_pass http://${NEW_NAME}:8080;
                }
            }
            EOF
            docker exec "$NGINX_CID" nginx -t
            docker exec "$NGINX_CID" nginx -s reload

            if [ "$NEW_NAME" = "${LIGHTSAIL_CONTAINER_NAME}-a" ]; then
              OLD_NAME="${LIGHTSAIL_CONTAINER_NAME}-b"
            else
              OLD_NAME="${LIGHTSAIL_CONTAINER_NAME}-a"
            fi
            docker stop --timeout 30 "$OLD_NAME" 2>/dev/null || true
            docker rm "$OLD_NAME" 2>/dev/null || true
            docker stop --timeout 30 "$LIGHTSAIL_CONTAINER_NAME" 2>/dev/null || true
            docker rm "$LIGHTSAIL_CONTAINER_NAME" 2>/dev/null || true
            rm -f /tmp/image.tar.gz
